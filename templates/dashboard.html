{% extends "base.html" %}

{% block title %}Dashboard - AR Card System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="glass-card p-4 mb-4 shadow-sm">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="text-white mb-0 fw-bold">
                    <i class="fas fa-dashboard me-2"></i>My AR Cards
                </h2>
                <button class="btn btn-custom btn-lg" data-bs-toggle="modal" data-bs-target="#createCardModal">
                    <i class="fas fa-plus me-2"></i>Create New Card
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row" id="cardsContainer">
    <div class="col-12 text-center">
        <div class="spinner"></div>
        <p class="text-white mt-2">Loading your cards...</p>
    </div>
</div>

<!-- Create Card Modal -->
<div class="modal fade" id="createCardModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white border-0 rounded-4 shadow-lg">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-plus me-2"></i>Create New AR Card
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createCardForm" enctype="multipart/form-data">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <label for="cardName" class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="cardName" required>
                            </div>
                            <div class="mb-2">
                                <label for="cardTitle" class="form-label">Job Title *</label>
                                <input type="text" class="form-control" id="cardTitle" required>
                            </div>
                            <div class="mb-2">
                                <label for="cardCompany" class="form-label">Company *</label>
                                <input type="text" class="form-control" id="cardCompany" required>
                            </div>
                            <div class="mb-2">
                                <label for="cardEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="cardEmail">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <label for="cardPhone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="cardPhone">
                            </div>
                            <div class="mb-2">
                                <label for="cardWebsite" class="form-label">Website</label>
                                <input type="url" class="form-control" id="cardWebsite">
                            </div>
                            <div class="mb-2">
                                <label for="cardLinkedin" class="form-label">LinkedIn</label>
                                <input type="url" class="form-control" id="cardLinkedin">
                            </div>
                            <div class="mb-2">
                                <label for="cardPhoto" class="form-label">Profile Photo</label>
                                <input type="file" class="form-control" id="cardPhoto" accept="image/*">
                            </div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label for="cardBio" class="form-label">Bio/Description</label>
                        <textarea class="form-control" id="cardBio" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-custom" onclick="createCard()">
                    <i class="fas fa-save me-2"></i>Create Card
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Card Modal -->
<div class="modal fade" id="editCardModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white border-0 rounded-4 shadow-lg">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-edit me-2"></i>Edit AR Card
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editCardForm" enctype="multipart/form-data">
                    <input type="hidden" id="editCardId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="mb-2">
                                <label for="editCardName" class="form-label">Full Name *</label>
                                <input type="text" class="form-control" id="editCardName" required>
                            </div>
                            <div class="mb-2">
                                <label for="editCardTitle" class="form-label">Job Title *</label>
                                <input type="text" class="form-control" id="editCardTitle" required>
                            </div>
                            <div class="mb-2">
                                <label for="editCardCompany" class="form-label">Company *</label>
                                <input type="text" class="form-control" id="editCardCompany" required>
                            </div>
                            <div class="mb-2">
                                <label for="editCardEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editCardEmail">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <label for="editCardPhone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="editCardPhone">
                            </div>
                            <div class="mb-2">
                                <label for="editCardWebsite" class="form-label">Website</label>
                                <input type="url" class="form-control" id="editCardWebsite">
                            </div>
                            <div class="mb-2">
                                <label for="editCardLinkedin" class="form-label">LinkedIn</label>
                                <input type="url" class="form-control" id="editCardLinkedin">
                            </div>
                            <div class="mb-2">
                                <label for="editCardPhoto" class="form-label">Profile Photo</label>
                                <input type="file" class="form-control" id="editCardPhoto" accept="image/*">
                                <img id="editCardPhotoPreview" src="" alt="Current Photo" class="mt-2 rounded-circle" style="width:80px;display:none;">
                            </div>
                        </div>
                    </div>
                    <div class="mb-2">
                        <label for="editCardBio" class="form-label">Bio/Description</label>
                        <textarea class="form-control" id="editCardBio" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-custom" onclick="submitEditCard()">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<div class="floating-action">
    <button class="btn btn-custom btn-lg" data-bs-toggle="modal" data-bs-target="#createCardModal">
        <i class="fas fa-plus"></i>
    </button>
</div>

{% for card in cards %}
<div class="card">
    <div class="card-header">
        <h5 class="card-title">{{ card.name }}</h5>
    </div>
    <div class="card-body">
        <p class="card-text">{{ card.bio }}</p>
        {% if card.photo_url %}
        <img src="{{ card.photo_url }}" alt="Profile Photo" class="img-fluid rounded-circle mb-3" style="width: 100px;">
        {% endif %}
        <div class="mb-3">
            <a href="mailto:{{ card.email }}" class="btn btn-primary btn-sm">
                <i class="fas fa-envelope"></i> Email
            </a>
            <a href="tel:{{ card.phone }}" class="btn btn-success btn-sm">
                <i class="fas fa-phone"></i> Call
            </a>
            <a href="{{ card.website }}" class="btn btn-info btn-sm" target="_blank">
                <i class="fas fa-globe"></i> Website
            </a>
            <a href="{{ card.linkedin }}" class="btn btn-linkedin btn-sm" target="_blank">
                <i class="fab fa-linkedin"></i> LinkedIn
            </a>
        </div>
        {% if card.qr_code %}
        <div class="qr-section">
            <img class="qr-img" src="data:image/png;base64,{{ card.qr_code }}" alt="QR Code">
            <a class="share-link" href="{{ card.qr_url }}" target="_blank">{{ card.qr_url }}</a>
            <div>
                <button class="btn" onclick="copyLink('{{ card.qr_url }}')">Copy Link</button>
                <a class="btn" href="/api/qr/{{ card.card_id }}/download">Download QR</a>
            </div>
        </div>
        {% endif %}
    </div>
    <div class="card-footer text-end">
        <button class="btn btn-secondary btn-sm" onclick="editCard('{{ card.card_id }}')">
            <i class="fas fa-edit"></i> Edit
        </button>
        <button class="btn btn-danger btn-sm" onclick="deleteCard('{{ card.card_id }}')">
            <i class="fas fa-trash"></i> Delete
        </button>
    </div>
</div>
{% endfor %}

<script>
function copyLink(link) {
    navigator.clipboard.writeText(link).then(function() {
        alert("Link copied to clipboard!");
    }, function() {
        alert("Failed to copy link.");
    });
}
</script>
{% endblock %}

{% block scripts %}
<script>
let currentCards = [];

async function loadCards() {
    try {
        const response = await fetch('/api/cards');
        if (response.ok) {
            const cards = await response.json();
            currentCards = cards;
            displayCards(cards);
        } else {
            showAlert('Failed to load cards', 'danger');
            document.getElementById('cardsContainer').innerHTML =
                '<div class="col-12 text-center text-white"><p>Failed to load cards</p></div>';
        }
    } catch (error) {
        showAlert('Network error', 'danger');
        document.getElementById('cardsContainer').innerHTML =
            '<div class="col-12 text-center text-white"><p>Network error</p></div>';
    }
}

function displayCards(cards) {
    const container = document.getElementById('cardsContainer');
    if (cards.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center">
                <div class="glass-card p-5 shadow-lg">
                    <i class="fas fa-id-card fa-3x text-white mb-3"></i>
                    <h4 class="text-white mb-3">No AR Cards Yet</h4>
                    <p class="text-white mb-4">Create your first AR business card to get started!</p>
                    <button class="btn btn-custom btn-lg" data-bs-toggle="modal" data-bs-target="#createCardModal">
                        <i class="fas fa-plus me-2"></i>Create Your First Card
                    </button>
                </div>
            </div>
        `;
        return;
    }
    let cardsHtml = '';
    cards.forEach(card => {
        cardsHtml += `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card-preview shadow-lg position-relative">
                    <div class="d-flex align-items-center mb-3">
                        ${card.photo_url ?
                            `<img src="${card.photo_url}" alt="Profile" class="profile-img me-3 border border-3 border-white">` :
                            `<div class="profile-img me-3 d-flex align-items-center justify-content-center bg-secondary">
                                <i class="fas fa-user fa-2x"></i>
                            </div>`
                        }
                        <div>
                            <h5 class="mb-1 fw-bold">${card.name}</h5>
                            <p class="mb-0 opacity-75">${card.title}</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <p class="mb-1"><i class="fas fa-building me-2"></i>${card.company}</p>
                        ${card.email ? `<p class="mb-1"><i class="fas fa-envelope me-2"></i>${card.email}</p>` : ''}
                        ${card.phone ? `<p class="mb-1"><i class="fas fa-phone me-2"></i>${card.phone}</p>` : ''}
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <button class="btn btn-light btn-sm fw-semibold" onclick="showQRCode('${card.card_id}')">
                            <i class="fas fa-qrcode me-1"></i>QR Code
                        </button>
                        <button class="btn btn-info btn-sm fw-semibold" onclick="previewAR('${card.card_id}')">
                            <i class="fas fa-cube me-1"></i>AR View
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="editCard('${card.card_id}')">
                                    <i class="fas fa-edit me-2"></i>Edit
                                </a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteCard('${card.card_id}')">
                                    <i class="fas fa-trash me-2"></i>Delete
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    container.innerHTML = cardsHtml;
}

async function createCard() {
    const formData = new FormData();
    formData.append('name', document.getElementById('cardName').value);
    formData.append('title', document.getElementById('cardTitle').value);
    formData.append('company', document.getElementById('cardCompany').value);
    formData.append('email', document.getElementById('cardEmail').value);
    formData.append('phone', document.getElementById('cardPhone').value);
    formData.append('website', document.getElementById('cardWebsite').value);
    formData.append('linkedin', document.getElementById('cardLinkedin').value);
    formData.append('bio', document.getElementById('cardBio').value);
    const photoFile = document.getElementById('cardPhoto').files[0];
    if (photoFile) {
        formData.append('photo', photoFile);
    }
    try {
        const response = await fetch('/api/cards', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (response.ok) {
            showAlert('Card created successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('createCardModal')).hide();
            document.getElementById('createCardForm').reset();
            loadCards();
        } else {
            showAlert(result.error || 'Failed to create card', 'danger');
        }
    } catch (error) {
        showAlert('Network error. Please try again.', 'danger');
    }
}

async function showQRCode(cardId) {
    try {
        const response = await fetch(`/api/qr/${cardId}`);
        if (response.ok) {
            const result = await response.json();
            document.getElementById('qrCodeImage').src = 'data:image/png;base64,' + result.qr_code;
            document.getElementById('qrUrl').textContent = result.qr_url;
            const qrModal = new bootstrap.Modal(document.getElementById('qrModal'));
            qrModal.show();
        } else {
            showAlert('Failed to load QR code', 'danger');
        }
    } catch (error) {
        showAlert('Network error', 'danger');
    }
}

function previewAR(cardId) {
    window.open(`/ar/${cardId}`, '_blank');
}

async function deleteCard(cardId) {
    if (!confirm('Are you sure you want to delete this card? This action cannot be undone.')) {
        return;
    }
    try {
        const response = await fetch(`/api/cards/${cardId}`, {
            method: 'DELETE'
        });
        if (response.ok) {
            showAlert('Card deleted successfully!', 'success');
            loadCards();
        } else {
            showAlert('Failed to delete card', 'danger');
        }
    } catch (error) {
        showAlert('Network error', 'danger');
    }
}

function editCard(cardId) {
    // Fetch card data and populate modal
    fetch(`/api/cards/${cardId}`)
        .then(res => res.json())
        .then(card => {
            document.getElementById('editCardId').value = card.card_id;
            document.getElementById('editCardName').value = card.name || '';
            document.getElementById('editCardTitle').value = card.title || '';
            document.getElementById('editCardCompany').value = card.company || '';
            document.getElementById('editCardEmail').value = card.email || '';
            document.getElementById('editCardPhone').value = card.phone || '';
            document.getElementById('editCardWebsite').value = card.website || '';
            document.getElementById('editCardLinkedin').value = card.linkedin || '';
            document.getElementById('editCardBio').value = card.bio || '';
            document.getElementById('editCardPhoto').value = '';
            // Show preview if photo_url exists
            const preview = document.getElementById('editCardPhotoPreview');
            if (card.photo_url) {
                preview.src = card.photo_url;
                preview.style.display = 'block';
            } else {
                preview.src = '';
                preview.style.display = 'none';
            }
            const modal = new bootstrap.Modal(document.getElementById('editCardModal'));
            modal.show();
        })
        .catch(() => showAlert('Failed to load card for editing', 'danger'));
}

function submitEditCard() {
    const cardId = document.getElementById('editCardId').value;
    const formData = new FormData();
    formData.append('name', document.getElementById('editCardName').value);
    formData.append('title', document.getElementById('editCardTitle').value);
    formData.append('company', document.getElementById('editCardCompany').value);
    formData.append('email', document.getElementById('editCardEmail').value);
    formData.append('phone', document.getElementById('editCardPhone').value);
    formData.append('website', document.getElementById('editCardWebsite').value);
    formData.append('linkedin', document.getElementById('editCardLinkedin').value);
    formData.append('bio', document.getElementById('editCardBio').value);
    const photoFile = document.getElementById('editCardPhoto').files[0];
    if (photoFile) {
        formData.append('photo', photoFile);
    }
    fetch(`/api/cards/${cardId}`, {
        method: 'PUT',
        body: formData
    })
    .then(async res => {
        if (res.ok) {
            showAlert('Card updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editCardModal')).hide();
            loadCards();
        } else {
            const result = await res.json();
            showAlert(result.error || 'Failed to update card', 'danger');
        }
    })
    .catch(() => showAlert('Network error. Please try again.', 'danger'));
}

document.addEventListener('DOMContentLoaded', loadCards);
</script>
{% endblock %}